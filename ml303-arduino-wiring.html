<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML-303 Arduino Integration Wiring</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #ff3333;
            text-align: center;
        }
        .wiring-diagram {
            background: #2a2a2a;
            border: 2px solid #ff3333;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        svg {
            width: 100%;
            height: auto;
        }
        .component {
            fill: #444;
            stroke: #888;
            stroke-width: 2;
        }
        .arduino {
            fill: #005C5C;
            stroke: #00a0a0;
        }
        .lcd {
            fill: #004400;
            stroke: #00ff00;
        }
        .ml303 {
            fill: #440000;
            stroke: #ff0000;
        }
        .wire {
            fill: none;
            stroke-width: 2;
        }
        .power {
            stroke: #ff0000;
        }
        .ground {
            stroke: #000000;
        }
        .signal {
            stroke: #00ff00;
        }
        .lcd-data {
            stroke: #ffff00;
        }
        text {
            fill: #fff;
            font-size: 12px;
        }
        .label {
            font-size: 14px;
            font-weight: bold;
        }
        .connection-table {
            background: #333;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
        th {
            background: #444;
            color: #ff3333;
        }
        .note {
            background: #3a3a00;
            border-left: 4px solid #ffff00;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ML-303 Arduino Integration Wiring Diagram</h1>
        
        <div class="note" style="background: #4a0000; border-left: 4px solid #ff0000;">
            <h3>üö® CRITICAL UPDATE - Pin Assignment Fixes!</h3>
            <p><strong>This wiring diagram has been corrected to match the FIXED Arduino code!</strong></p>
            <p>The original code had major pin conflicts that would prevent operation. Key changes:</p>
            <ul>
                <li><strong>LCD pins changed:</strong> Now uses D12, D11, D10, D9, D8, D7 (no conflicts)</li>
                <li><strong>MIDI moved:</strong> Now uses A4/A5 for software serial (not D12/D13)</li>
                <li><strong>DAC added:</strong> MCP4921 on D13 (CS), D11 (SCK/MOSI) for CV output</li>
                <li><strong>All conflicts resolved:</strong> Every pin assignment verified</li>
            </ul>
            <p><strong>‚ö†Ô∏è Do NOT use the original pin assignments - they will NOT work!</strong></p>
        </div>
        
        <div class="wiring-diagram">
            <svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
                <!-- Arduino Micro -->
                <rect class="component arduino" x="50" y="200" width="200" height="300" rx="5"/>
                <text x="150" y="190" text-anchor="middle" class="label">Arduino Micro</text>
                
                <!-- Pin labels -->
                <text x="40" y="230" text-anchor="end">5V</text>
                <text x="40" y="250" text-anchor="end">GND</text>
                <text x="40" y="280" text-anchor="end">A0</text>
                <text x="40" y="300" text-anchor="end">A1</text>
                <text x="40" y="320" text-anchor="end">A2</text>
                <text x="40" y="340" text-anchor="end">A3</text>
                <text x="40" y="360" text-anchor="end">A4</text>
                <text x="40" y="380" text-anchor="end">A5</text>
                <text x="40" y="420" text-anchor="end">D2</text>
                <text x="40" y="440" text-anchor="end">D3</text>
                <text x="40" y="460" text-anchor="end">D4</text>
                <text x="40" y="480" text-anchor="end">D5</text>
                <text x="260" y="230" text-anchor="start">D6</text>
                <text x="260" y="250" text-anchor="start">D7</text>
                <text x="260" y="270" text-anchor="start">D8</text>
                <text x="260" y="290" text-anchor="start">D9</text>
                <text x="260" y="310" text-anchor="start">D10</text>
                <text x="260" y="330" text-anchor="start">D11</text>
                <text x="260" y="350" text-anchor="start">D12</text>
                <text x="260" y="370" text-anchor="start">D13</text>
                
                <!-- LCD Display -->
                <rect class="component lcd" x="350" y="100" width="150" height="120" rx="5"/>
                <text x="425" y="90" text-anchor="middle" class="label">SMH1602A LCD</text>
                <text x="425" y="140" text-anchor="middle">16x2 Display</text>
                <text x="425" y="155" text-anchor="middle">(Parallel Interface)</text>
                
                <!-- LCD Pins -->
                <text x="340" y="120" text-anchor="end">VCC</text>
                <text x="340" y="135" text-anchor="end">GND</text>
                <text x="340" y="150" text-anchor="end">V0</text>
                <text x="340" y="165" text-anchor="end">RS</text>
                <text x="340" y="180" text-anchor="end">E</text>
                <text x="340" y="195" text-anchor="end">D4</text>
                <text x="340" y="210" text-anchor="end">D5</text>
                <text x="340" y="225" text-anchor="end">D6</text>
                <text x="340" y="240" text-anchor="end">D7</text>
                <text x="340" y="210" text-anchor="end">LED¬±</text>
                
                <!-- ML-303 Interface Points -->
                <rect class="component ml303" x="350" y="250" width="200" height="250" rx="5"/>
                <text x="450" y="240" text-anchor="middle" class="label">ML-303 Interface</text>
                
                <!-- ML-303 connection points -->
                <text x="340" y="280" text-anchor="end">Cutoff</text>
                <text x="340" y="300" text-anchor="end">Resonance</text>
                <text x="340" y="320" text-anchor="end">Env Mod</text>
                <text x="340" y="340" text-anchor="end">Decay</text>
                <text x="340" y="380" text-anchor="end">Clock In</text>
                <text x="340" y="400" text-anchor="end">Gate In</text>
                <text x="340" y="420" text-anchor="end">Run/Stop</text>
                <text x="340" y="440" text-anchor="end">Pattern</text>
                <text x="340" y="460" text-anchor="end">Gate Out</text>
                <text x="340" y="480" text-anchor="end">DAC CS</text>
                
                <!-- MIDI Circuit -->
                <rect class="component" x="600" y="300" width="120" height="100" rx="5"/>
                <text x="660" y="290" text-anchor="middle" class="label">MIDI I/O</text>
                <text x="590" y="330" text-anchor="end">MIDI IN</text>
                <text x="590" y="370" text-anchor="end">MIDI OUT</text>
                
                <!-- Wiring connections -->
                <!-- Power -->
                <line class="wire power" x1="250" y1="225" x2="350" y2="115"/>
                <line class="wire ground" x1="250" y1="245" x2="350" y2="130"/>
                <!-- DAC Power -->
                <line class="wire power" x1="250" y1="225" x2="590" y2="165"/>
                <line class="wire ground" x1="250" y1="245" x2="590" y2="225"/>
                <!-- DAC SPI -->
                <line class="wire signal" x1="250" y1="370" x2="590" y2="180"/>  <!-- CS -->
                <line class="wire signal" x1="250" y1="330" x2="590" y2="195"/>  <!-- SCK (shared) -->
                <line class="wire signal" x1="250" y1="330" x2="590" y2="210"/>  <!-- SDI (MOSI) -->
                
                <!-- LCD Control Lines -->
                <line class="wire lcd-data" x1="250" y1="350" x2="350" y2="165"/>  <!-- D12 to RS -->
                <line class="wire lcd-data" x1="250" y1="330" x2="350" y2="180"/>  <!-- D11 to E -->
                <!-- LCD Data Lines -->
                <line class="wire lcd-data" x1="250" y1="310" x2="350" y2="195"/>  <!-- D10 to D4 -->
                <line class="wire lcd-data" x1="250" y1="290" x2="350" y2="210"/>  <!-- D9 to D5 -->
                <line class="wire lcd-data" x1="250" y1="270" x2="350" y2="225"/>  <!-- D8 to D6 -->
                <line class="wire lcd-data" x1="250" y1="250" x2="350" y2="240"/>  <!-- D7 to D7 -->
                
                <!-- Analog inputs -->
                <line class="wire signal" x1="250" y1="275" x2="350" y2="275"/>
                <line class="wire signal" x1="250" y1="295" x2="350" y2="295"/>
                <line class="wire signal" x1="250" y1="315" x2="350" y2="315"/>
                <line class="wire signal" x1="250" y1="335" x2="350" y2="335"/>
                
                <!-- Control Inputs -->
                <line class="wire signal" x1="250" y1="420" x2="350" y2="420"/>  <!-- D2 to Run/Stop -->
                <line class="wire signal" x1="250" y1="440" x2="350" y2="440"/>  <!-- D3 to Pattern -->
                <line class="wire signal" x1="250" y1="460" x2="350" y2="380"/>  <!-- D4 to Clock -->
                <line class="wire signal" x1="250" y1="480" x2="350" y2="400"/>  <!-- D5 to Gate In -->
                <!-- Digital Outputs -->
                <line class="wire signal" x1="250" y1="230" x2="350" y2="460"/>  <!-- D6 to Gate Out -->
                <line class="wire signal" x1="250" y1="370" x2="350" y2="480"/>   <!-- D13 to DAC CS -->
                
                <!-- MIDI -->
                <line class="wire signal" x1="250" y1="360" x2="600" y2="325"/>  <!-- A4 to MIDI RX -->
                <line class="wire signal" x1="250" y1="380" x2="600" y2="365"/>  <!-- A5 to MIDI TX -->
                
                <!-- Power Supply -->
                <rect class="component" x="50" y="50" width="120" height="80" rx="5"/>
                <text x="110" y="40" text-anchor="middle" class="label">Power Supply</text>
                <text x="110" y="90" text-anchor="middle">+12V/-12V</text>
                <text x="110" y="105" text-anchor="middle">+5V (USB)</text>
                
                <!-- MCP4921 DAC -->
                <rect class="component" x="600" y="150" width="80" height="80" rx="5"/>
                <text x="640" y="140" text-anchor="middle" class="label">MCP4921</text>
                <text x="640" y="190" text-anchor="middle">12-bit DAC</text>
                
                <!-- DAC Pins -->
                <text x="590" y="165" text-anchor="end">VCC</text>
                <text x="590" y="180" text-anchor="end">CS</text>
                <text x="590" y="195" text-anchor="end">SCK</text>
                <text x="590" y="210" text-anchor="end">SDI</text>
                <text x="590" y="225" text-anchor="end">GND</text>
                <text x="690" y="180" text-anchor="start">VOUT</text>
                
                <!-- LCD Contrast Circuit -->
                <rect class="component" x="350" y="30" width="80" height="40" rx="5"/>
                <text x="390" y="25" text-anchor="middle" class="label">10k Pot</text>
                <text x="390" y="50" text-anchor="middle">Contrast</text>
                <line class="wire power" x1="350" y1="40" x2="320" y2="40"/>
                <line class="wire ground" x1="430" y1="60" x2="460" y2="60"/>
                <line class="wire signal" x1="390" y1="70" x2="390" y2="150"/>
                <text x="320" y="45">+5V</text>
                <text x="465" y="65">GND</text>
                <text x="395" y="80">V0</text>
            </svg>
        </div>
        
        <div class="connection-table">
            <h2>Connection Details</h2>
            <table>
                <tr>
                    <th>Arduino Pin</th>
                    <th>Connection</th>
                    <th>Function</th>
                    <th>Notes</th>
                </tr>
                <tr>
                    <td>5V</td>
                    <td>LCD VCC</td>
                    <td>Power supply</td>
                    <td>Can also use external 5V</td>
                </tr>
                <tr>
                    <td>GND</td>
                    <td>LCD GND, ML-303 GND</td>
                    <td>Common ground</td>
                    <td>Star ground recommended</td>
                </tr>
                <tr>
                    <td>A0-A3</td>
                    <td>Pot wipers</td>
                    <td>Parameter reading</td>
                    <td>Use 10k linear pots</td>
                </tr>
                <tr>
                    <td>D12</td>
                    <td>LCD RS</td>
                    <td>Register Select</td>
                    <td>Standard parallel interface</td>
                </tr>
                <tr>
                    <td>D11</td>
                    <td>LCD E</td>
                    <td>Enable</td>
                    <td>Standard parallel interface</td>
                </tr>
                <tr>
                    <td>D10</td>
                    <td>LCD D4</td>
                    <td>Data bit 4</td>
                    <td>4-bit mode operation</td>
                </tr>
                <tr>
                    <td>D9</td>
                    <td>LCD D5</td>
                    <td>Data bit 5</td>
                    <td>4-bit mode operation</td>
                </tr>
                <tr>
                    <td>D8</td>
                    <td>LCD D6</td>
                    <td>Data bit 6</td>
                    <td>4-bit mode operation</td>
                </tr>
                <tr>
                    <td>D7</td>
                    <td>LCD D7</td>
                    <td>Data bit 7</td>
                    <td>4-bit mode operation</td>
                </tr>
                <tr>
                    <td>10k pot</td>
                    <td>LCD V0</td>
                    <td>Contrast control</td>
                    <td>Between +5V and GND</td>
                </tr>
                <tr>
                    <td>D2</td>
                    <td>Run/Stop switch</td>
                    <td>Transport control</td>
                    <td>Internal pullup enabled (INT0)</td>
                </tr>
                <tr>
                    <td>D3</td>
                    <td>Pattern select</td>
                    <td>Pattern switching</td>
                    <td>Momentary switch to GND (INT1)</td>
                </tr>
                <tr>
                    <td>D4</td>
                    <td>Clock In</td>
                    <td>PIC clock signal</td>
                    <td>Connect to ML-303 test point</td>
                </tr>
                <tr>
                    <td>D5</td>
                    <td>Gate In</td>
                    <td>Gate monitor</td>
                    <td>Monitor ML-303 gate output</td>
                </tr>
                <tr>
                    <td>D6</td>
                    <td>Gate Out</td>
                    <td>Gate output</td>
                    <td>PWM capable pin</td>
                </tr>
                <tr>
                    <td>A4</td>
                    <td>MIDI RX (via optocoupler)</td>
                    <td>MIDI receive</td>
                    <td>Software serial, 6N138 circuit</td>
                </tr>
                <tr>
                    <td>A5</td>
                    <td>MIDI TX</td>
                    <td>MIDI transmit</td>
                    <td>Software serial, 220Œ© resistor</td>
                </tr>
                <tr>
                    <td>D13</td>
                    <td>DAC CS (MCP4921)</td>
                    <td>SPI chip select</td>
                    <td>CV output DAC control</td>
                </tr>
            </table>
        </div>
        
        <div class="note">
            <h3>Hardware Implementation Notes:</h3>
            <ul>
                <li><strong>VERIFIED:</strong> All pin assignments match the fixed Arduino code</li>
                <li>Keep digital and analog grounds separate, connect at one point only</li>
                <li>Use shielded cable for all audio connections</li>
                <li>Place Arduino away from sensitive analog circuits</li>
                <li>Add 0.1¬µF bypass capacitors near all IC power pins</li>
                <li>Standard HD44780 LCD requires 6 data pins plus power and contrast control</li>
                <li>10k potentiometer REQUIRED for contrast adjustment (V0 pin)</li>
                <li>220Œ© resistor needed for LED backlight current limiting</li>
                <li>MCP4921 DAC requires hardware SPI connection (pins 11, 13)</li>
                <li>MIDI optocoupler circuit essential for isolation</li>
                <li>All pin assignments verified against fixed Arduino code</li>
            </ul>
        </div>
        
        <div class="connection-table">
            <h2>MCP4921 DAC Wiring (CV Output)</h2>
            <table>
                <tr>
                    <th>MCP4921 Pin</th>
                    <th>Arduino Pin</th>
                    <th>Function</th>
                    <th>Notes</th>
                </tr>
                <tr>
                    <td>1 (VCC)</td>
                    <td>5V</td>
                    <td>Power supply</td>
                    <td>+5V supply</td>
                </tr>
                <tr>
                    <td>2 (CS)</td>
                    <td>D13</td>
                    <td>Chip Select</td>
                    <td>Active low</td>
                </tr>
                <tr>
                    <td>3 (SCK)</td>
                    <td>D11 (SCK)</td>
                    <td>SPI Clock</td>
                    <td>Hardware SPI</td>
                </tr>
                <tr>
                    <td>4 (SDI)</td>
                    <td>D11 (MOSI)</td>
                    <td>SPI Data</td>
                    <td>Hardware SPI</td>
                </tr>
                <tr>
                    <td>7 (VSS)</td>
                    <td>GND</td>
                    <td>Ground</td>
                    <td>Digital ground</td>
                </tr>
                <tr>
                    <td>8 (VOUT)</td>
                    <td>CV Output</td>
                    <td>Analog CV</td>
                    <td>0-4.096V output</td>
                </tr>
            </table>
        </div>
        
        <div class="connection-table">
            <h2>MIDI Interface Circuit</h2>
            <table>
                <tr>
                    <th>Component</th>
                    <th>Connection</th>
                    <th>Function</th>
                    <th>Notes</th>
                </tr>
                <tr>
                    <td>6N138 Pin 2</td>
                    <td>MIDI IN Pin 4</td>
                    <td>MIDI current loop</td>
                    <td>Via 220Œ© resistor</td>
                </tr>
                <tr>
                    <td>6N138 Pin 3</td>
                    <td>MIDI IN Pin 5</td>
                    <td>MIDI current loop</td>
                    <td>Via 220Œ© resistor</td>
                </tr>
                <tr>
                    <td>6N138 Pin 6</td>
                    <td>Arduino A4</td>
                    <td>Isolated output</td>
                    <td>Software serial RX</td>
                </tr>
                <tr>
                    <td>6N138 Pin 8</td>
                    <td>+5V</td>
                    <td>Logic supply</td>
                    <td>Via 4.7kŒ© pullup</td>
                </tr>
                <tr>
                    <td>Arduino A5</td>
                    <td>MIDI OUT Pin 5</td>
                    <td>MIDI transmit</td>
                    <td>Via 220Œ© resistor</td>
                </tr>
            </table>
        </div>
        
        <div class="connection-table">
            <h2>CD4049 Simple Overdrive Wiring</h2>
            <p>For the recommended simple overdrive configuration:</p>
            <svg viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg">
                <rect class="component" x="50" y="100" width="100" height="100" rx="5"/>
                <text x="100" y="90" text-anchor="middle" class="label">CD4049</text>
                
                <!-- Pins -->
                <circle cx="50" cy="130" r="5" fill="#fff"/>
                <circle cx="150" cy="130" r="5" fill="#fff"/>
                <circle cx="50" cy="170" r="5" fill="#fff"/>
                <circle cx="150" cy="170" r="5" fill="#fff"/>
                
                <text x="40" y="135" text-anchor="end">3</text>
                <text x="160" y="135">2</text>
                <text x="40" y="175" text-anchor="end">5</text>
                <text x="160" y="175">4</text>
                
                <!-- Input -->
                <text x="20" y="50" class="label">From VCA Out</text>
                <line class="wire signal" x1="20" y1="60" x2="20" y2="130"/>
                <line class="wire signal" x1="20" y1="130" x2="50" y2="130"/>
                
                <!-- Between stages -->
                <line class="wire signal" x1="150" y1="130" x2="200" y2="130"/>
                <line class="wire signal" x1="200" y1="130" x2="200" y2="170"/>
                <line class="wire signal" x1="200" y1="170" x2="50" y2="170"/>
                
                <!-- Output -->
                <line class="wire signal" x1="150" y1="170" x2="250" y2="170"/>
                <rect class="component" x="250" y="160" width="80" height="20" rx="2"/>
                <text x="290" y="175" text-anchor="middle">100k Level</text>
                <line class="wire signal" x1="330" y1="170" x2="380" y2="170"/>
                <text x="400" y="175">To Output</text>
                
                <!-- Capacitor -->
                <line x1="20" y1="120" x2="20" y2="140" stroke="#fff" stroke-width="2"/>
                <line x1="10" y1="120" x2="30" y2="120" stroke="#fff" stroke-width="2"/>
                <line x1="10" y1="140" x2="30" y2="140" stroke="#fff" stroke-width="2"/>
                <text x="40" y="130">0.1¬µF</text>
            </svg>
        </div>
    </div>
</body>
</html>